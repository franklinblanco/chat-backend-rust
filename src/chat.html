<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>WebSocket Chat</title>
    </head>
    <body>
        <h1>WebSocket Chat Example</h1>

        <input id="username" style="display:block; width:100px; box-sizing: border-box" type="text" placeholder="username">
        <button id="join-chat" type="button">Join Chat</button>
        <textarea id="chat" style="display:block; width:600px; height:400px; box-sizing: border-box" cols="30" rows="10"></textarea>
        <input id="input" style="display:block; width:600px; box-sizing: border-box" type="text" placeholder="chat">

        <script>
            const username = document.querySelector("#username");
            const join_btn = document.querySelector("#join-chat");
            const textarea = document.querySelector("#chat");
            const input = document.querySelector("#input");

            join_btn.addEventListener("click", function(e) {
                let time;
                this.disabled = true;
                const addr_for_client = window.location.href.substring(6);
                console.log(addr_for_client)
                const websocket = new WebSocket("ws://" + addr_for_client +"websocket");
                var login_body = {};
                if (username.value === "1") {
                    login_body = {"id": "1", "token": "EQfXEWahJqDKWtGMCrFmeK1RME+hETYpezmj8qiguE+5vfJVE8p9TMPwa4m48IO7wA6E3ffkNEIc7Jushuze7A=="}
                } else if (username.value === "2") {
                    login_body = {"id": "2", "token": "TGYW1si4amdwk/Jj8l6r/4BApRdWdx45PoOQOFKIEftt9gZKpHwQbL3lrH36LTgwoKha/80TKiMYGiUHNt+MVQ=="}
                }
                websocket.onopen = function() {
                    websocket.send(JSON.stringify({"head": "LOGIN", "body": login_body}));
                }

                const btn = this;

                websocket.onclose = function() {
                    console.log("connection closed");
                    btn.disabled = false;
                }

                websocket.onmessage = function(e) {
                    const parsed_msg = JSON.parse(e.data);
                    console.log("received message: "+e.data);
                    if (parsed_msg.head === "MESSAGE DELIVERED") {
                        textarea.value += "Message: [" + parsed_msg.body.message.Text + "] Delivered to " + parsed_msg.body.timeDelivered.list.length + " users, including you."+"\r\n";
                    }
                    if (parsed_msg.head === "MESSAGE SEEN") {
                        textarea.value += "Message: [" + parsed_msg.body.message.Text + "] Seen by " + parsed_msg.body.timeSeen.list.length + " users, including you."+"\r\n";
                    }
                    if (parsed_msg.head === "MESSAGE SENT") {
                        textarea.value += "Message sent in " + (Date.now() - time).toString() + "ms" + "\r\n"; 
                    }
                    if (parsed_msg.head === "MESSAGE RECIEVED") {
                        websocket.send(JSON.stringify({"head": "SEE MESSAGES", "body": [JSON.parse(e.data).body.id]}))
                        if (parsed_msg.body.fromId.toString() !== login_body.id) {
                            textarea.value += "Message: [" + parsed_msg.body.message.Text + "] Recieved from user id: " + parsed_msg.body.fromId +"\r\n";
                        }
                    }

                }

                input.onkeydown = function(e) {
                    if (e.key == "Enter") {
                        time = Date.now()
                        websocket.send(JSON.stringify({"head": "SEND MESSAGE", "body": {"message": {"Text": input.value}, "to": 1}}));
                        input.value = "";
                    }
                }
            });
        </script>
    </body>
</html>